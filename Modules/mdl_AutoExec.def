'################################################################################################
' This module will initialize the application to work properly with all components of relevance.
' InitApp will be called by the macro AutoExec during startup.
'################################################################################################

Option Compare Database
Option Explicit

' -----------------------------------------------------------------------------------------------
' Public variables and Global constants
' -----------------------------------------------------------------------------------------------

' Database connection timeout
Public Const pConnectionTimeout = 5

' Application title shown as form title
Public Const pAppTitle = "LABDESK LIMS"

' Semantic Versioning according to https://semver.org/
' MAJOR-MINOR-PATCH
Public Const pBeVersion = "v1.0.0" 'Backend version
Public Const pFeVersion = "v1.0.0" 'Frontend version
Public Const pReVersion = "v1.0.0" 'Release version (used for licence check)
Public Const pLcSecret = "_gfmf!jshd*n#jü7/hhs&" 'Licence secret for encryption
Public Const pReportTemplate = "labreport_main" 'Separate report names using comma

' Cache folder setting
Public Const pCacheFolder = ".labdesk"

' Licence server address
Public Const pLicenceServer = "https://licence.labdesk.net/licence.php?"

' Licence validity (if not valid then forms will be set to read only)
Global pValidLic As Boolean

' Remote tables to be linked
Global DSNLessTables As Variant

' -----------------------------------------------------------------------------------------------
' Any code goes from here
' -----------------------------------------------------------------------------------------------

Public Function AddAppProperty(strName As String, varType As Variant, varValue As Variant) As Boolean
'-------------------------------------------------------------------------------
' Function:     AddAppProperty
' Date:         2022 May
' Purpose:      Set an application property
' In:
' -> title:     Title of the application
' Out:          Done (T/F)
'-------------------------------------------------------------------------------
Dim dbs As Object, prp As Variant
Const conPropNotFoundError = 3270
 
Set dbs = CurrentDb
On Error GoTo Catch_Error
dbs.Properties(strName) = varValue
AddAppProperty = True
 
Exit_Function:
    Exit Function
 
Catch_Error:
    If Err = conPropNotFoundError Then
        Set prp = dbs.CreateProperty(strName, varType, varValue)
        dbs.Properties.Append prp
        Resume
    Else
        AddAppProperty = False
        Resume Exit_Function
    End If
End Function

Public Sub HideNavPane(bVisible As Boolean)
'-------------------------------------------------------------------------------
' Function:     HideNavPane
' Date:         2022 January
' Purpose:      Control the visibility of the Access Navigation Pane
' Parameters:
' -> bVisible   True/False - whether the Nav Pane should be visible or not
' Out:          -
'-------------------------------------------------------------------------------
    On Error GoTo Catch_Error
 
    If SysCmd(acSysCmdRuntime) = False Then
        If bVisible = True Then
            '            DoCmd.SelectObject acTable, , True
            DoCmd.SelectObject acModule, , True
        Else
            '            DoCmd.SelectObject acTable, , True
            DoCmd.SelectObject acModule, , True
            DoCmd.RunCommand acCmdWindowHide
        End If
    End If
 
Exit_Function:
    Exit Sub
Catch_Error:
    MsgBox "Error (mdlAutoExec - HideNavPane): " & Err.description, vbCritical, "Error"
    Resume Exit_Function
End Sub

Function ap_DisableShift()
'This function disable the shift at startup. This action causes
'the Autoexec macro and Startup properties to always be executed.

On Error GoTo errDisableShift

Dim db As DAO.database
Dim prop As DAO.Property
Const conPropNotFound = 3270

Set db = CurrentDb()

'This next line disables the shift key on startup.
db.Properties("AllowByPassKey") = False

'The function is successful.
Exit Function

errDisableShift:
'The first part of this error routine creates the "AllowByPassKey
'property if it does not exist.
If Err = conPropNotFound Then
Set prop = db.CreateProperty("AllowByPassKey", _
dbBoolean, False)
db.Properties.Append prop
Resume Next
Else
MsgBox "Function 'ap_DisableShift' did not complete successfully."
Exit Function
End If
End Function

Function ap_EnableShift()
'This function enables the SHIFT key at startup. This action causes
'the Autoexec macro and the Startup properties to be bypassed
'if the user holds down the SHIFT key when the user opens the database.

On Error GoTo errEnableShift

Dim db As DAO.database
Dim prop As DAO.Property
Const conPropNotFound = 3270

Set db = CurrentDb()

'This next line of code disables the SHIFT key on startup.
db.Properties("AllowByPassKey") = True

'function successful
Exit Function

errEnableShift:
'The first part of this error routine creates the "AllowByPassKey
'property if it does not exist.
If Err = conPropNotFound Then
Set prop = db.CreateProperty("AllowByPassKey", _
dbBoolean, True)
db.Properties.Append prop
Resume Next
Else
MsgBox "Function 'ap_DisableShift' did not complete successfully."
Exit Function
End If
End Function

Public Function InitApp() As Boolean
'-------------------------------------------------------------------------------
' Function:     InitApp
' Date:         2022 January
' Purpose:      Init the application settings
' Parameters:   -
' Out:          Done (T/F)
'-------------------------------------------------------------------------------
On Error GoTo Catch_Error

    DSNLessTables = Array( _
    "filter", "translation", "setup", _
    "contact", "laboratory", "customer", "manufacturer", "smppoint", "smpcontainer", "smpmatrix", "material", _
    "cfield", "cvalidate", "condition", "uncertainty", "analysis", "attribute", "method_analysis", "method", "qualification", "instrument_method", "department", "workplace", "instrument", "certificate", "attachment", "instype", "supplier", _
    "request", "measurement_cfield", "measurement", "measurement_condition", "view_request_measurement", _
    "profile_analysis", "profile", "request_analysis", "step", "state", "workflow", "smptype", "smpcondition", "smppreservation", "priority", "technique", _
    "batch", "btcposition", "storage", "strposition", "handbook", _
    "project", "project_member", "formulation", "component", _
    "view_measurement", _
    "users", "role", "role_permission", "permission", "traversal", "audit", "spa", "columns", _
    "view_labreport_details", _
    "view_attachment_revision", _
    "mailqueue" _
    )
    
    'Try to attach tables
    If ConnectDb(GetDbSetting("server"), GetDbSetting("database"), DSNLessTables, GetDbSetting("user"), GetDbSetting("password")) = False Then
        Err.Raise vbObjectError + 513, , "Connecting to database failed."
    End If
    
    'Init application (initialization routine needs to be called just once for setup reasons)
    If GetFieldValue("dbsetup", "sysinit", 1) = True Then
        If MsgBox("Press OK to initialize application. This may take a while.", vbOKCancel, "Information") = vbOK Then
            sysinit
            MsgBox "System initialization finished. Restart application to proceed.", vbInformation, "Information"
            Exit Function
        Else
            Exit Function
        End If
    End If
    
    'Clean Cache (stored in the user folder under pCacheFolder)
    CleanCache
    
    'Init context menus
    InitContextMenuStd
    InitContextMenuStdDpl
    InitContextMenuRqst
    InitContextMenuFlt
    InitContextMenuFile
    InitContextMenuSubStd
    
    'Check Version (raise error if backend does not match)
    If GetBeVersion() <> pBeVersion Then
        MsgBox "Error (mdlAutoExec - InitApp): Backend version not supported. (Actual: " & GetBeVersion() & " | Required: " & pBeVersion & ")", vbCritical, "Error"
        Err.Raise vbObjectError + 513, , "Backend version not supported. (Actual: " & GetBeVersion() & " | Required: " & pBeVersion & ")"
    End If
    
    'Check if user exists otherwise add
    AddUser
    
    'Open desktop tab
    If Application.SysCmd(acSysCmdGetObjectState, acForm, "desktop") <> acObjStateOpen Then DoCmd.OpenForm "desktop", acNormal, , , acFormReadOnly, acWindowNormal
    
    'Interface cosmetics
    AddAppProperty "AppTitle", dbText, pAppTitle
    Application.RefreshTitleBar
    SysCmd acSysCmdSetStatus, "User: " & GetUserName()
    HideNavPane GetDbSetting("navpane")
 
    'Check for valid subscription otherwise read onyl will be appplied
    If Not ValidLicence(False) Then
        Err.Raise vbObjectError + 513, , "Not a valid licence."
    Else
        pValidLic = True
    End If
    
    'Open the closing event form
    DoCmd.OpenForm "*closing_event_form", acNormal, , , acFormReadOnly, acWindowNormal
    Forms("*closing_event_form").visible = False
    
    InitApp = True
    
Exit_Function:
    Exit Function
Catch_Error:
    InitApp = False
    DoCmd.OpenForm "dbsetup", acNormal, , , acFormEdit
    Resume Exit_Function
End Function