Option Compare Database
Option Explicit

Private Sub InitTranslations()
    ' MsgBox title translations
    GetTranslation "msgbox", "vbInformation", GetDbSetting("language")
    GetTranslation "tooltip", "click_to_upload", GetDbSetting("language")
    GetTranslation "tooltip", "click_to_upload", GetDbSetting("language")
    GetTranslation "msgbox", "entries_not_valid", GetDbSetting("language")
    GetTranslation "msgbox", "record_deactivated", GetDbSetting("language")
    
    ' Translations of form certificate_edit
    GetTranslation "certificate_edit", "creation_date_wrong", GetDbSetting("language")
    GetTranslation "certificate_edit", "valid_from_till_date_wrong", GetDbSetting("language")
    
    GetTranslation "analysis_edit", "wrong_detection_limts", GetDbSetting("language")
    GetTranslation "analysis_edit", "calculation_test", GetDbSetting("language")
    
    GetTranslation "analysis_method_sbf", "set_standard_method_failed", GetDbSetting("language")
    
    GetTranslation "analysis_uncertainty_sbf", "mandantory_field_not_filled", GetDbSetting("language")
    GetTranslation "analysis_uncertainty_sbf", "min_bigger_max", GetDbSetting("language")
    GetTranslation "analysis_uncertainty_sbf", "mandantory_field_not_filled", GetDbSetting("language")
    
    GetTranslation "certificate", "creation_date_wrong", GetDbSetting("language")
    GetTranslation "certificate", "valid_from_date_wrong", GetDbSetting("language")
    GetTranslation "certificate", "valid_till_date_wrong", GetDbSetting("language")
    
    GetTranslation "certificate_edit", "creation_date_wrong", GetDbSetting("language")
    GetTranslation "certificate_edit", "valid_from_date_wrong", GetDbSetting("language")
    GetTranslation "certificate_edit", "valid_till_date_wrong", GetDbSetting("language")
    
    GetTranslation "department_edit", "department_deactivation_failed", GetDbSetting("language")
    
    GetTranslation "instrument", "result_folder_unvalid", GetDbSetting("language")
    
    GetTranslation "instrument_edit", "result_folder_unvalid", GetDbSetting("language")
    
    GetTranslation "instrument_method_sbf", "standard_invalid", GetDbSetting("language")
    
    GetTranslation "measurement_edit", "qualification_expired", GetDbSetting("language")
    GetTranslation "measurement_edit", "method_missing", GetDbSetting("language")
    GetTranslation "measurement_edit", "certificate_expired", GetDbSetting("language")
    GetTranslation "measurement_edit", "not_numeric", GetDbSetting("language")
    
    GetTranslation "method_analysis_sbf", "standard_invalid", GetDbSetting("language")
    
    GetTranslation "qualification", "creation_date_wrong", GetDbSetting("language")
    GetTranslation "qualification", "valid_from_date_wrong", GetDbSetting("language")
    GetTranslation "qualification", "valid_till_date_wrong", GetDbSetting("language")
    
    GetTranslation "qualification_edit", "creation_date_wrong", GetDbSetting("language")
    GetTranslation "qualification_edit", "valid_from_date_wrong", GetDbSetting("language")
    GetTranslation "qualification_edit", "valid_till_date_wrong", GetDbSetting("language")
    
    GetTranslation "request", "wrong_cc_email", GetDbSetting("language")
    
    GetTranslation "request_edit", "not_validateable", GetDbSetting("language")
    GetTranslation "request_edit", "request_retracted_subject", GetDbSetting("language")
    GetTranslation "request_edit", "request_retracted_body", GetDbSetting("language")
    GetTranslation "request_edit", "request_report_subject", GetDbSetting("language")
    GetTranslation "request_edit", "request_report_body", GetDbSetting("language")
    
    GetTranslation "report", "subject_retract", GetDbSetting("language")
    GetTranslation "report", "subject_labreport", GetDbSetting("language")
    GetTranslation "report", "body_labreport", GetDbSetting("language")
    GetTranslation "report", "body_retract", GetDbSetting("language")
    
    GetTranslation "role", "admin_group_already_exists", GetDbSetting("language")
    
    GetTranslation "workplace", "workplace_deactivation_failed", GetDbSetting("language")
    
    GetTranslation "project_member", "member_exists", GetDbSetting("language")
End Sub

Private Sub AddTranslation(container As String, item As String, en As String)
    Dim db As database
    Dim rs As Recordset
    
    Set db = CurrentDb()
    Set rs = db.OpenRecordset("SELECT COUNT(id) As cnt FROM translation WHERE container = '" & container & "' AND item = '" & item & "'")
    
    If rs!cnt = 0 Then
        db.Execute "INSERT INTO translation (container, item, en) VALUES ('" & container & "', '" & item & "', '" & en & "')"
    End If
End Sub

Private Sub UpdateTranslation()
    Dim db As database
    Dim rs As Recordset
    
    Set db = CurrentDb()
    Set rs = db.OpenRecordset("SELECT * FROM _translation")
    
    Do While Not rs.EOF
        AddTranslation rs!container, rs!item, rs!en
        rs.MoveNext
    Loop
End Sub

Private Sub AddRole(title As String, description As String, administrative As Boolean)
    Dim db As database
    Dim rs As Recordset
    
    Set db = CurrentDb()
    Set rs = db.OpenRecordset("SELECT COUNT(id) As cnt FROM role WHERE title = '" & title & "'")
    
    If rs!cnt = 0 Then
        db.Execute "INSERT INTO role (title, description, administrative) VALUES ('" & title & "', '" & description & "', " & CInt(administrative) & ")"
    End If
End Sub

Private Sub UpdateRole()
    Dim db As database
    Dim rs As Recordset
    
    Set db = CurrentDb()
    Set rs = db.OpenRecordset("SELECT * FROM _role")
    
    Do While Not rs.EOF
        AddRole rs!title, rs!description, rs!administrative
        rs.MoveNext
    Loop
End Sub

Private Sub AddPermission(title As String, description As String)
    Dim db As database
    Dim rs As Recordset
    
    Set db = CurrentDb()
    Set rs = db.OpenRecordset("SELECT COUNT(id) As cnt FROM permission WHERE title = '" & title & "'")
    
    If rs!cnt = 0 Then
        db.Execute "INSERT INTO permission (title, description) VALUES ('" & title & "', '" & description & "')"
    End If
End Sub

Private Sub UpdatePermission()
    Dim db As database
    Dim rs As Recordset
    
    Set db = CurrentDb()
    Set rs = db.OpenRecordset("SELECT * FROM _permission")
    
    Do While Not rs.EOF
        If Not IsNull(rs!description) Then
            AddPermission rs!title, rs!description
        Else
            AddPermission rs!title, ""
        End If
        rs.MoveNext
    Loop
End Sub

Private Sub AddRolePermission(role As Integer, permission As Integer, can_create As Boolean, can_read As Boolean, can_update As Boolean, can_delete As Boolean)
    Dim db As database
    Dim rs As Recordset
    
    Set db = CurrentDb()
    
    db.Execute "UPDATE role_permission SET can_create = " & CInt(can_create) & ", can_read = " & CInt(can_read) & ", can_update = " & CInt(can_update) & ", can_delete = " & CInt(can_delete) & " WHERE permission = " & permission & " AND role = " & role
End Sub

Private Sub UpdateRolePermission()
    Dim db As database
    Dim rs As Recordset
    Dim ra, rb, rx, ry As Recordset
    
    Set db = CurrentDb()
    Set rs = db.OpenRecordset("SELECT * FROM _role_permission")
    
    Do While Not rs.EOF
        Set ra = db.OpenRecordset("SELECT * FROM _role WHERE id = " & rs!role)
        Set rb = db.OpenRecordset("SELECT * FROM role WHERE title = '" & ra!title & "'", dbOpenDynaset, dbSeeChanges)
        Set rx = db.OpenRecordset("SELECT * FROM _permission WHERE id = " & rs!permission)
        Set ry = db.OpenRecordset("SELECT * FROM permission WHERE title = '" & rx!title & "'", dbOpenDynaset, dbSeeChanges)
        
        AddRolePermission rb!id, ry!id, True, rs!can_read, rs!can_update, rs!can_delete
        rs.MoveNext
    Loop
End Sub

Public Sub SysPrep()
'-------------------------------------------------------------------------------
'Function:          SysPrep
'Date:              2022 February
'Purpose:           Create s local copy of all configurations
'-------------------------------------------------------------------------------

    ' Translations
    If TableExists("_translation") Then CurrentDb.TableDefs.Delete "_translation"
    CreateTable "translation", "_translation"
    CopyTable "translation", "_translation"
    
    ' Filters
    If TableExists("_filter") Then CurrentDb.TableDefs.Delete "_filter"
    CreateTable "filter", "_filter"
    CopyTable "filter", "_filter"
    
    ' Roles
    If TableExists("_role") Then CurrentDb.TableDefs.Delete "_role"
    CreateTable "role", "_role"
    CopyTable "role", "_role"
    
    ' Permissions
    If TableExists("_permission") Then CurrentDb.TableDefs.Delete "_permission"
    CreateTable "permission", "_permission"
    CopyTable "permission", "_permission"
    
    ' Role permission cross table
    If TableExists("_role_permission") Then CurrentDb.TableDefs.Delete "_role_permission"
    CreateTable "role_permission", "_role_permission"
    CopyTable "role_permission", "_role_permission"
    
    ' Unlink DSN less tables
    UnAttachDSNLessTables DSNLessTables
    
    ' Activate initialization
    CurrentDb.Execute "UPDATE dbsetup SET sysinit = 1"
    
    ' Disable shift
    ap_DisableShift
End Sub

Public Sub sysinit()
'-------------------------------------------------------------------------------
'Function:          SysInit
'Date:              2021 October
'Purpose:           Update the database with local a copy of all configurations
'-------------------------------------------------------------------------------
    InitTranslations
    UpdateTranslation
    UpdateRole
    UpdatePermission
    UpdateRolePermission
    AddAdmin
    ' Deactivate initialization
    CurrentDb.Execute "UPDATE dbsetup SET sysinit = 0"
End Sub